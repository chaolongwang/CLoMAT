# Simulation codes for the CLoMAT paper

Here we provide the data and scripts to reproduce the null and power simulations presented in the CLoMAT paper:

* S Cheng\*, J Lyu\*, X Shi, K Wang, Z Wang, M Deng, B Sun#, C Wang#. Rare variant association tests for ancestry-matched case-control data based on conditional logistic regression. *Briefings in Bioinformatics*, in press. (\* Co-first authors; # Corresponding authors)



## 1. Requirements

All scripts were written in [R](https://www.r-project.org/). Functions for association tests and matching were written in the following *R* scripts:

- `CLoMAT.R` includes functions for CLR-Burden,  CLR-SKAT and CLR-MiST.
- `SKATL.R` includes functions required for the SKAT likelihood ratio tests.
- `pairmatch.R` implements the heuristic *1-to-m* matching algorithm described in the paper of Cheng *et al.*

These scripts should be placed in the working directory. 

In addition, the following *R* packages are required: *survival*, *survey*, *SKAT*, *optmatch*, and *CompQuadForm*.



## 2. Data files

We simulated genotype data with population structure, including 20,000 individuals distributed on a 20x20 lattice, using the coalescent simulator [ms](http://home.uchicago.edu/~rhudson1/source/mksamples.html). Details of the parameter settings were described in the paper (Cheng *et al.*). Because there are tedious steps to format the data from the *ms* outputs to the proper inputs, we directly provide the formatted data files to download. Codes for the coalescent simulation can be requested from the authors.

The input genotype files and PC coordinate files are placed in the tarball `data.tar.gz`. After decompressing using command `tar xzvf data.tar.gz`, you will find the following data files:

* `/data/BiRareMarkerAllIndividualGeneSet1_5000.SSD` and `/data/BiRareMarkerAllIndividualGeneSet1_5000.Info`: genotype data of rare variants (minor allele frequency <0.05) from 5,000 genes in the [SKAT](https://cran.r-project.org/web/packages/SKAT/index.html) file format. While we have simulated 20,000 genes, we can only upload an example dataset of 5,000 genes due to the file size limitation of GitHub.

- `/data/AllMarkerAllIndividual.frq`: allele freqeuncy of all simulated biallelic SNPs (1 million SNPs from 20,000 genes).
- `/data/M10.20x20.20000.1M.RefPC.coord`: PCA coordinates of 1,200 reference individuals (3 individuals per population, generated by [LASER](http://csg.sph.umich.edu/chaolong/LASER/)).
- `/data/M10.20x20.20000.1M.ProPC.coord`: PCA coordinates of all 20,000 individuals, by projecting the each individual onto the reference PCA space of 1,200 reference individuals using the *trace* program implemented in the [LASER](http://csg.sph.umich.edu/chaolong/LASER/) package.  
- `/data/BiRareMarkerAllIndividual.fam` : individual information of of all 20,000 individuals.



 ## 3. Scripts to perform simulations

Both type 1 error and power simulations involves 3 steps, which were implemented in separate *R* scripts.

### Step 1. Simulate disease status

- `Null_step1_simulate_phenotype.R`: simulate case/control status for all individuals under the null model, with the spatial risk distribution specified by the argument *casetype*.
- `Power_step1_simulate_phenotype.R`: simulate case/control status for all individuals under the alternative model. The prespecified arguments include the proportion of causal variants in a gene (*CausalPercent*), the proportion of protective variants within causal variants (*PositivePercent*), the coefficient c (*Constant*), and the spatial risk distribution (*casetype*).

This step will output files containing the IDs of all cases and controls. 

### Step 2. Perform matching

- `Null_step2_perform_matching.R`: perform matching and prepare phenotype files for association tests for the null simulations.
- `Power_step2_perform_matching.R`: perform matching and prepare phenotype files for association tests for the power simulations.

Both scripts require specification of the spatial risk distribution (*casetype*) and the matching scheme (*Match*). 

Mathcing is performed based on top 2 PCs. A phenotype file containing disease status, covariates, and the mathcing strata will be generated in this step. 

### Step 3. Perform association tests

- `Null_step3_perform_test.R`: perform association tests for the null simulations.
- `Power_step3_perform_test.R`: perform association tests for the power simulations.

Specification of the spatial risk distribution (*casetype*) and matching scheme (*Match*) is required for both scripts in order to read the corresponding phenotype file generated in Step 2. 

Each script will take the input genotype and phenotype files, and perform association tests, including Burden, SKAT, MiST, CLR-Burden, CLR-SKAT, and CLR-MiST. Test results will be output in files.



 ## 4. Run simulations

To reproduce the simulations presented in the paper, please run the following *bash* scripts.

- `Run_null_simulations.sh`: commands to reproduce the null simulations.
- `Run_power_simulations.sh`: commands to reproduce the power simulations.

Results can be visualized by running the following *R* scripts.

- `Null_plot_results.R`: generate QQ plots for type 1 error evaluation under the null model.
- `Power_plot_results.R`: generate bar plots for power comparison under the alternative model.



 ## 5. Contact information

If you have questions regarding the codes, please contact Drs. Baoluo Sun (stasb@nus.edu.sg) or Jingjing Lyu (lyuj@hust.edu.cn) or Chaolong Wang (chaolong@hust.edu.cn).

